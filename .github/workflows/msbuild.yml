name: Build and Compile C++ Project with Dependencies

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  BUILD_CONFIGURATION: Release
  CMAKE_GENERATOR: "Visual Studio 16 2019"  # Or change this based on the MSVC version installed
  BOOST_VERSION: "1.58"  # The Boost version you're using
  NLOHMANN_JSON_VERSION: "3.10.5"  # The nlohmann_json version you're using

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up CMake
      uses: cmake/setup-cmake@v2
      with:
        cmake-version: '3.21.1'

    - name: Cache Boost and nlohmann_json dependencies
      uses: actions/cache@v3
      with:
        path: |
          CMakeCache.txt
          CMakeFiles/
          build/
        key: ${{ runner.os }}-boost-${{ env.BOOST_VERSION }}-nlohmann_json-${{ env.NLOHMANN_JSON_VERSION }}
        restore-keys: |
          ${{ runner.os }}-boost-${{ env.BOOST_VERSION }}-nlohmann_json-${{ env.NLOHMANN_JSON_VERSION }}

    - name: Install Boost
      run: |
        choco install boost-msvc-${{ env.BOOST_VERSION }} --version=${{ env.BOOST_VERSION }}

    - name: Install nlohmann_json via vcpkg
      run: |
        curl -LO https://github.com/microsoft/vcpkg/releases/download/2022.05.15/vcpkg-x64-windows.zip
        unzip vcpkg-x64-windows.zip
        .\vcpkg\bootstrap-vcpkg.bat
        .\vcpkg\vcpkg install nlohmann-json:${{ env.NLOHMANN_JSON_VERSION }}

    - name: Configure and Build CMake project
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_CONFIGURATION }} -DCMAKE_TOOLCHAIN_FILE=path_to_vcpkg_toolchain_file
        cmake --build . --config ${BUILD_CONFIGURATION}

    - name: Run Tests (optional)
      run: |
        ctest --output-on-failure
